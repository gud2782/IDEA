<!DOCTYPE html>
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header_content :: header_content" />
<link rel="stylesheet" th:href="@{/css/style_form.css}">


<!-- Font-->
<link rel="stylesheet" type="text/css" href="/css/opensans-font.css">
<link rel="stylesheet" type="text/css" href="/fonts/material-design-iconic-font/css/material-design-iconic-font.min.css">
<!-- Main Style Css -->
<!--    <link rel="stylesheet" href="/css/style_blood.css"/>-->
<script type="text/javascript" src="/js/jsQR.js"></script>




<!--   ì¹´ì¹´ì˜¤ ìŠ¤í¬ë¦½íŠ¸-->

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d1a6cacadaec20832158d15aa9ad1c41&libraries=services"></script>
<link href="/css/map.css" rel="stylesheet">
<!--<script src="/js/map.js"></script>-->


</head>

<!--navbar-->
<div th:replace="fragments/navbar_content :: navbar_content"/>
<!--navbar end-->
<body>
<div class="page-content">
	<div class="form-v1-content">
		<div class="wizard-form">
			<form id="qrcodeForm" name="qrcodeForm" th:object="${qrcodeForm}" class="form-register" method="post" autocomplete="off">
				<input type="text" id="dhash" name="dhash" value="dhash" th:id="dhash" th:for="dhash" th:field="*{dhash}" hidden>
				<div id="form-total">
					<!-- SECTION 1 -->
					<h2>
						<p class="step-icon"><span>01</span></p>
						<span class="step-text">ì¡°íšŒ</span>
					</h2>
					<section>
						<div class="inner">
							<div class="wizard-header">
								<h3 class="heading">ë™ë¬¼ë“±ë¡ë²ˆí˜¸ ì¡°íšŒ</h3>
								<p>ë°˜ë ¤ê²¬ ë“±ë¡ ë‹¹ì‹œ ì…ë ¥í•œ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
							</div>
							<div class="form-row">
								<div class="form-holder form-holder-1">
									<input type="text" name="bNumber" id="bNumber"  class="form-control" placeholder="í˜ˆì•¡ë²ˆí˜¸" th:id="bNumber" th:for="bNumber" >
								</div>
								<div class="form-holder form-holder-4">
								<input class="modal-btn2" type="checkbox" id="qrcode2" name="modal-btn2"/>
								<label for="qrcode2">í˜ˆì•¡ë²ˆí˜¸ ì¡°íšŒ<i class="fa fa-qrcode" aria-hidden="true" STYLE="text-align: center" ></i></label>
									<div class="modal2" name="modal2" id="modal2">
										<div class="modal-wrap2">
											<div class="qrBox2" >
												<div class="modalQRcode2">
													<div class="modal_content2">
														<div id="frame2">
															<div id="loadingMessage2" hidden>
																ğŸ¥ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì— ì•¡ì„¸ìŠ¤ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br/>ì›¹ìº ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤
															</div> <!-- loadingMessage-->
															<canvas id="canvas2" style="width: 400px; height: 300px"></canvas>
														</div> <!-- frame-->
													</div> <!-- modal_content-->
												</div><!-- modalQRcode-->
											</div>
											<p>Contrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old.</p>
										</div>
									</div>
								</div>
							</div>
							<div class="form-row">
								<div class="form-holder form-holder-1">
									<input type="text"  name="dosId" id="dosId" placeholder="ë™ë¬¼ë“±ë¡ë²ˆí˜¸" class="form-control"
										   th:id="dosId" th:for="dosId" >
								</div>
								<div class="form-holder form-holder-4">
									<input class="modal-btn" type="checkbox" id="qrcode" name="modal-btn"/>
									<label for="qrcode">QRCODE ì¡°íšŒ<i class="fa fa-qrcode" aria-hidden="true" STYLE="text-align: center" ></i></label>
									<div class="modal" name="modal" id="modal">
										<div class="modal-wrap">
											<div class="qrBox" >
												<div class="modalQRcode">
													<div class="modal_content">
														<div id="frame">
															<div id="loadingMessage" hidden>
																ğŸ¥ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì— ì•¡ì„¸ìŠ¤ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br/>ì›¹ìº ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤
															</div> <!-- loadingMessage-->
															<canvas id="canvas" style="width: 400px; height: 300px"></canvas>
														</div> <!-- frame-->
													</div> <!-- modal_content-->
												</div><!-- modalQRcode-->
											</div>
											<p>Contrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old.</p>
										</div>
									</div>
								</div>
							</div>


						</div>
					</section>



					<!-- SECTION 2 -->
					<h2>
						<p class="step-icon"><span>02</span></p>
						<span class="step-text">ë“±ë¡</span>
					</h2>
					<section>
						<div class="inner">
							<div class="wizard-header">
								<h3 class="heading">í—Œí˜ˆê²¬ ì •ë³´ ë“±ë¡</h3>
								<p>Please enter your infomation and proceed to the next step so we can build your accounts.  </p>
							</div>
							<div class="form-row">
								<div class="form-holder">
									<fieldset>
										<legend>ë°˜ë ¤ê²¬ ì´ë¦„</legend>
										<input type="text" class="form-control" id="dosName" name="dosName" th:for="dosName"  required>
									</fieldset>
								</div>
								<div class="form-holder">
									<fieldset>
										<legend>ë™ë¬¼ë“±ë¡ë²ˆí˜¸</legend>
										<input type="text" class="form-control" id="dosId2" name="dosId2" th:for="dosId"  required>
									</fieldset>
								</div>
							</div>
							<div class="form-row">
								<div class="form-holder">
									<fieldset>
										<legend>ìˆ˜í˜ˆì–‘</legend>
										<input type="text" name="dPack" id="dPack" class="form-control" th:for="dPack"   required>
									</fieldset>
								</div>
								<div class="form-holder">
									<fieldset>
										<legend>ê²¬ì¢…</legend>
										<input type="text" class="form-control" id="kind" name="kind" th:for="kind"  required>
									</fieldset>
								</div>
							</div>
							<div class="form-row">
								<div class="form-holder">
									<fieldset>
										<legend>ìˆ˜í˜ˆë‚ ì§œ</legend>
										<input type="text" name="dDate" id="dDate" class="form-control" th:for="dDate"   required>
									</fieldset>
								</div>
								<div class="form-holder">
									<fieldset>
										<legend>í˜ˆì•¡í˜•</legend>
										<input type="text" class="form-control" id="type" name="type" th:for="type"  required>
									</fieldset>
								</div>
							</div>
							<div class="form-row">
								<div class="form-holder form-holder-2">
									<fieldset>
										<legend>ìˆ˜í˜ˆ ê¸°ê´€</legend>
										<input type="text" class="form-control" id="dHos" name="dHos" th:for="dHos"  placeholder="ê±´êµ­ëŒ€í•™êµ ìˆ˜ì˜ë³‘ì›" required>
									</fieldset>
								</div>
							</div>
						</div>
						<!--ì¶”ê°€-->
						<div class="form-row">
							<div class="form-holder form-holder-2">
								<fieldset>
									<input type="button" name="find_bank" id="check" value="ë“±ë¡" class="form-control" onclick="toAjax()">
								</fieldset>
							</div>
						</div>
					</section>

					<!-- SECTION 3 -->
					<h2>
						<p class="step-icon"><span>03</span></p>
						<span class="step-text">ì™„ë£Œ</span>
					</h2>
					<section>
						<div class="inner">
							<div class="wizard-header">
								<h3 class="heading">THANK YOU!</h3>
								<p>Please enter your infomation and proceed to the next step so we can build your accounts.</p>
							</div>
							<div class="form-row">
								<div class="form-holder form-holder-2">
									<input type="radio" class="radio" name="radio1" id="plan-1" value="plan-1">
									<label class="plan-icon plan-1-label" for="plan-1">
										<img src="/img/form-v1-icon-2.png" alt="pay-1">
									</label>
									<div class="plan-total">
										<span class="plan-title">ì ‘ì¢… ì •ë³´ ë“±ë¡</span>
										<p class="plan-text">Pellentesque nec nam aliquam sem et volutpat consequat mauris nunc congue nisi.</p>
									</div>
									<input type="radio" class="radio" name="radio1" id="plan-2" value="plan-2">
									<label class="plan-icon plan-2-label" for="plan-2">
										<img src="/img/form-v1-icon-2.png" alt="pay-1">
									</label>
									<div class="plan-total">
										<span class="plan-title">ìˆ˜í˜ˆê²¬ ì •ë³´ ë“±ë¡</span>
										<p class="plan-text">Pellentesque nec nam aliquam sem et volutpat consequat mauris nunc congue nisi.</p>
									</div>
									<input type="radio" class="radio" name="radio1" id="plan-3" value="plan-3" checked>
									<label class="plan-icon plan-3-label" for="plan-3">
										<img src="/img/form-v1-icon-3.png" alt="pay-2">
									</label>
									<div class="plan-total">
										<span class="plan-title">ë§ˆì´í˜ì´ì§€</span>
										<p class="plan-text">Pellentesque nec nam aliquam sem et volutpat consequat mauris nunc congue nisi.</p>
									</div>
								</div>
							</div>
						</div>
					</section>
				</div>
			</form>
		</div>
	</div>
</div>

</body>
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/jquery.steps.js"></script>
<script src="/js/main.js"></script>




<script type="text/javascript" >
	$(function(){
		$("#qrcode").click(function() {
			$(".modalQRcode").fadeIn();

			var video = document.createElement("video");
			var canvasElement = document.getElementById("canvas");
			var canvas = canvasElement.getContext("2d");
			var loadingMessage = document.getElementById("loadingMessage");
			var dosId = document.getElementById("dosId");
			function drawLine(begin, end, color) {
				canvas.beginPath();
				canvas.moveTo(begin.x, begin.y);
				canvas.lineTo(end.x, end.y);
				canvas.lineWidth = 4;
				canvas.strokeStyle = color;
				canvas.stroke();
			}
			// ì¹´ë©”ë¼ ì‚¬ìš©ì‹œ
			navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
				video.srcObject = stream;
				video.setAttribute("playsinline", true);      // iOS ì‚¬ìš©ì‹œ ì „ì²´ í™”ë©´ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒì„ ì „ë‹¬
				video.play();
				requestAnimationFrame(tick);
			});
			async function tick() {
				loadingMessage.innerText = "âŒ› ìŠ¤ìº” ê¸°ëŠ¥ì„ í™œì„±í™” ì¤‘ì…ë‹ˆë‹¤."
				if(video.readyState === video.HAVE_ENOUGH_DATA) {
					loadingMessage.hidden = true;
					canvasElement.hidden = false;
					// outputContainer.hidden = false;
					// ì½ì–´ë“¤ì´ëŠ” ë¹„ë””ì˜¤ í™”ë©´ì˜ í¬ê¸°
					canvasElement.height = video.videoHeight;
					canvasElement.width = video.videoWidth;
					canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
					var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
					var code = jsQR(imageData.data, imageData.width, imageData.height, {
						inversionAttempts : "dontInvert",
					});
					// QRì½”ë“œ ì¸ì‹ì— ì„±ê³µí•œ ê²½ìš°
					if(code) {
						// ì¸ì‹í•œ QRì½”ë“œì˜ ì˜ì—­ì„ ê°ì‹¸ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” í…Œë‘ë¦¬ ìƒì„±
						drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FFCE49");
						drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FFCE49");
						drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FFCE49");
						drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FFCE49");


						// QRì½”ë“œ ë©”ì‹œì§€ ì¶œë ¥
						dosId.innerHTML = code.data;

						const dosId2 = code.data;
						$('#dosId2').val(dosId2);
						$('#dosId').val(dosId2);
						//console.log(`dosId:${dosId}`);
						console.log(`dosId:`+dosId2);
						//ì¹´ë©”ë¼ ì‚¬ë¼ì§€ê¸°
						$(".modal").fadeOut();


						//ì¶”ê°€
						var sendDataById = "dosId="+dosId2;

						$.ajax({
							url: "/donation/find",
							type: "post",
							data: sendDataById,

							success: function (result) {
								alert(result);

								let getResultById = result.split(",");
								let dosName, kind, dDate, dHos, dPack, type, dWeight

								for (let idx=0; idx < 7; idx++){
									let value = getResultById [idx];
									if(idx == 0){
										dosName= value;
									}else if(idx == 1){
										kind= value;
									}else if(idx==2){
										dDate= value;
									}else if(idx==3) {
										dHos=value;
									}else if(idx==4) {
										dPack=value;
									}else if(idx==5) {
										type=value;
									}else if(idx==6) {
										dWeight=value;
									}

								}
								document.getElementById('dosName').value = dosName;
								document.getElementById('kind').value = kind;
								document.getElementById('dDate').value = dDate;
								document.getElementById('dHos').value = dHos;
								document.getElementById('dPack').value = dPack;
								document.getElementById('type').value = type;
								document.getElementById('dWeight').value = dWeight;


								//console.log(aniName + aniId + kind + weight + color);

							},
							error: function (sendDataById) {
								alert("ì‹¤íŒ¨ : " + sendDataById);
							}
						});

						return;
					}
					// QRì½”ë“œ ì¸ì‹ì— ì‹¤íŒ¨í•œ ê²½ìš°
					else {
						// outputMessage.hidden = false;
						// outputData.parentElement.hidden = true;
					}
				}
				requestAnimationFrame(tick);


			}


		});
	});
	$(function(){
		$("#qrcode2").click(function() {
			$(".modalQRcode2").fadeIn();

			var video = document.createElement("video");
			var canvasElement = document.getElementById("canvas2");
			var canvas = canvasElement.getContext("2d");
			var loadingMessage2 = document.getElementById("loadingMessage2");
			var bNumber = document.getElementById("bNumber");
			function drawLine(begin, end, color) {
				canvas.beginPath();
				canvas.moveTo(begin.x, begin.y);
				canvas.lineTo(end.x, end.y);
				canvas.lineWidth = 4;
				canvas.strokeStyle = color;
				canvas.stroke();
			}
			// ì¹´ë©”ë¼ ì‚¬ìš©ì‹œ
			navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
				video.srcObject = stream;
				video.setAttribute("playsinline", true);      // iOS ì‚¬ìš©ì‹œ ì „ì²´ í™”ë©´ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒì„ ì „ë‹¬
				video.play();
				requestAnimationFrame(tick);
			});
			async function tick() {
				loadingMessage2.innerText = "âŒ› ìŠ¤ìº” ê¸°ëŠ¥ì„ í™œì„±í™” ì¤‘ì…ë‹ˆë‹¤."
				if(video.readyState === video.HAVE_ENOUGH_DATA) {
					loadingMessage2.hidden = true;
					canvasElement.hidden = false;
					// outputContainer.hidden = false;
					// ì½ì–´ë“¤ì´ëŠ” ë¹„ë””ì˜¤ í™”ë©´ì˜ í¬ê¸°
					canvasElement.height = video.videoHeight;
					canvasElement.width = video.videoWidth;
					canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
					var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
					var code = jsQR(imageData.data, imageData.width, imageData.height, {
						inversionAttempts : "dontInvert",
					});
					// QRì½”ë“œ ì¸ì‹ì— ì„±ê³µí•œ ê²½ìš°
					if(code) {
						// ì¸ì‹í•œ QRì½”ë“œì˜ ì˜ì—­ì„ ê°ì‹¸ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” í…Œë‘ë¦¬ ìƒì„±
						drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FFCE49");
						drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FFCE49");
						drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FFCE49");
						drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FFCE49");


						// QRì½”ë“œ ë©”ì‹œì§€ ì¶œë ¥
						bNumber.innerHTML = code.data;

						const bNumber2 = code.data;
						$('#bNumber').val(bNumber2);
						console.log(`bNumber:${bNumber}`);
						//ì¹´ë©”ë¼ ì‚¬ë¼ì§€ê¸°
						$(".modal2").fadeOut();

						return;
					}
					// QRì½”ë“œ ì¸ì‹ì— ì‹¤íŒ¨í•œ ê²½ìš°
					else {

					}
				}
				requestAnimationFrame(tick);
			}
		});
	});
</script>
<script type="text/javascript">
	// document.addEventListener("DOMContentLoaded",
</script>

<!--footer -->
<div th:replace="fragments/footer_content :: footer_content" />
<!--footer-end -->
<script src="/bootstrap/js/bootstrap.min.js"></script>
<!--ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/caver-js/1.6.5-rc.2/caver.min.js" integrity="sha512-2PMOAlTrOMvxwtl+AB67naKpUtzNVdwRmychnd2lIuaRg1HlqAiJ0qd4miDWKKfcHZi6gX5NKAfeb+wfD3094w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" th:inline="javascript">

	function toAjax() {

		console.log("1");

		var dosId2 =$("#dosId2").val();
		var dosName=$("#dosName").val();
		var dPack=$("#dPack").val();
		var kind=$("#kind").val();
		var dDate=$("#dDate").val();
		var type=$("#type").val();
		var dHos=$("#dHos").val();
		var neutralization=$("#neutralization").val();


		let http = new XMLHttpRequest();
		let url = 'https://metadata-api.klaytnapi.com/v1/metadata';
		let data= {
			"metadata": {
				"name": "í˜ˆì•¡-í—Œí˜ˆê²¬ë“±ë¡ì •ë³´",
				"image": "https://metadata-store.klaytnapi.com/e2d83vdb-c108-823c-d5f3-69vdf2d871c51/4a85e6be-3215-93e6-d8a9-3a7d633584e7.png",
				"dosId" : dosId2,
				"dosName" : dosName,
				"dPack" : dPack,
				"kind" : kind,
				"dDate" : dDate,
				"type" : type,
				"dHos" : dHos

			}

		}
		http.open('POST', url, true);


		//Send the proper header information along with the request
		http.setRequestHeader('Content-type', 'application/json');
		http.setRequestHeader('Authorization', 'Basic S0FTS1IwQTNDMVA4SUNRS0Q5V1dJSThTOmZHeVZodlFieUh1dTdHdWl1TjV2eWdodmdlSU9fcXl5ZlhqYUlUVkc=');
		http.setRequestHeader('x-chain-id', '1001');

		http.onreadystatechange = function() {//Call a function when the state changes.
			// mintToken(http.responseText);
			console.log('META-STATE', http.readyState)
			if(http.readyState !=4) return;
			console.log(http.response)
			var jsonArray =http.responseText
			var jsonParsedArray = JSON.parse(jsonArray);

			mintToken(jsonParsedArray["uri"]);   //í† í°ìƒì„±


			console.log("8")




		}
		http.send(JSON.stringify(data));
		console.log("7")





	}


	//í† í° ìƒì„±(ë°ì´í„°ë¥¼ í† í°í™”í•˜ì—¬ ë¸”ë¡ì²´ì¸ì— ì „ì†¡)

	function mintToken(uri) {
		let timestamp= Math.floor(new Date().getTime() / 1000);

		// console.log("=====start mintToken======");
		// console.log("timestamp >>> " +timestamp);
		let http = new XMLHttpRequest();
		let url = 'https://kip17-api.klaytnapi.com/v1/contract/0x5c8b5eb9571d6e413801737eb16502181df7ff91/token';
		let data= {
			"to": "0x5fbf75a9fdfd1d9180ea8242da08d7f9ae4a772e", //í˜•ìš°ë‹˜ í…ŒìŠ¤íŠ¸ ì£¼ì†Œ
			"id": "0x"+timestamp, //ê³„ì • timestampí•¨ìˆ˜ë¥¼ í†µí•´ ìƒì„±, ì•„ì´ë”” í•˜ë‚˜ë‹¹ í•œë²ˆì˜ í† í°ë§Œ ìƒì„±í•  ìˆ˜ ìˆìŒ
			"uri": uri
		}
		http.open('POST', url, true);


		//Send the proper header information along with the request
		http.setRequestHeader('Content-type', 'application/json');
		http.setRequestHeader('Authorization', 'Basic S0FTS1IwQTNDMVA4SUNRS0Q5V1dJSThTOmZHeVZodlFieUh1dTdHdWl1TjV2eWdodmdlSU9fcXl5ZlhqYUlUVkc=');
		http.setRequestHeader('x-chain-id', '1001');

		http.onreadystatechange = function() {//Call a function when the state changes.
			console.log('TOKEN-STATE', http.readyState)
			if(http.readyState !=4) return;

			let jsonResult = JSON.parse(http.responseText);
			let dhash = jsonResult.transactionHash;


			$('#dhash').val(dhash);
			alert(dhash);
			var form = document.qrcodeForm;
			form.action="/bNumber/new/donation";
			form.submit();


		}
		http.send(JSON.stringify(data));

	}


</script>


</html>